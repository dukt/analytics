!function(e){Analytics.Realtime=Garnish.Base.extend({$element:null,$title:null,$body:null,$error:null,$activeUsers:null,$realtimeVisitors:null,$pageviewsChart:null,$activePagesTable:null,$activePagesTableBody:null,$activePagesTableBodyNoData:null,chart:null,chartData:null,chartOptions:null,timer:!1,settings:null,init:function(t,i){this.setSettings(i),this.$element=e("#"+t),this.$title=e(".title",this.$element),this.$body=e(".body",this.$element),this.$error=e(".error",this.$element),this.$realtimeVisitors=e(".analytics-realtime-visitors",this.$element),this.$activeUsers=e(".active-users",this.$realtimeVisitors),this.$pageviewsChart=e(".pageviews .chart",this.$element),this.$pageviewsNoData=e(".pageviews .nodata",this.$element),this.$activePagesTable=e(".active-pages table",this.$element),this.$activePagesTableBody=e(".active-pages table tbody",this.$element),this.$activePagesNoData=e(".active-pages .nodata",this.$element),this.loadGoogleCharts(e.proxy((function(){this.addListener(Garnish.$win,"resize","_handleWindowResize"),this.startTimer()}),this))},loadGoogleCharts:function(t){AnalyticsRealtime.GoogleVisualizationCalled||(google.charts.load("current",{packages:["corechart","bar"],language:Analytics.chartLanguage,mapsApiKey:Analytics.mapsApiKey}),AnalyticsRealtime.GoogleVisualizationCalled=!0),google.charts.setOnLoadCallback(e.proxy((function(){t()}),this))},startTimer:function(){this.timer&&this.stopTimer(),this.request(),this.timer=setInterval(e.proxy((function(){this.request()}),this),1e3*this.settings.refreshInterval)},stopTimer:function(){clearInterval(this.timer)},request:function(){var t={viewId:this.settings.viewId};Craft.queueActionRequest("analytics/reports/realtime-widget",t,e.proxy((function(e,t){if("success"===t&&void 0===e.error)this.$error.addClass("hidden"),this.$realtimeVisitors.removeClass("hidden"),this.handleResponse(e);else{var i="An unknown error occured.";void 0!==e&&e&&void 0!==e.error&&(i=e.error),this.$realtimeVisitors.addClass("hidden"),this.$error.html(i),this.$error.removeClass("hidden")}}),this))},handleResponse:function(e){this.handleActiveUsers(e.activeUsers),this.handlePageviews(e.pageviews),this.handleActivePages(e.activePages)},handleActiveUsers:function(e){this.$activeUsers.text(e)},handlePageviews:function(t){var i=new google.visualization.DataTable;for(i.addColumn("number",Craft.t("analytics","Minutes ago")),i.addColumn("number",Craft.t("analytics","Pageviews")),t.rows&&t.rows.length>0?(this.$pageviewsChart.removeClass("hidden"),this.$pageviewsNoData.addClass("hidden")):(this.$pageviewsChart.addClass("hidden"),this.$pageviewsNoData.removeClass("hidden")),minutesAgo=30;minutesAgo>=0;minutesAgo--){var s=0;e.each(t.rows,(function(e,t){parseInt(t[0])===minutesAgo&&(s=parseInt(t[1]))}));var a=Craft.t("analytics","{count} minutes ago",{count:minutesAgo});1==minutesAgo&&(a=Craft.t("analytics","{count} minute ago",{count:minutesAgo})),i.addRow([{v:minutesAgo,f:a},s])}this.chartData=i,this.chartOptions={height:150,theme:"maximized",bar:{groupWidth:"90%"},legend:{position:"bottom"},hAxis:{direction:-1,baselineColor:"transparent",gridlineColor:"transparent",textPosition:"none",gridlines:{count:0}},vAxis:{baselineColor:"#fff",gridlineColor:"#fff",textPosition:"none",gridlines:{count:0}}},this.chart=new google.visualization.ColumnChart(this.$pageviewsChart.get(0)),this.chart.draw(this.chartData,this.chartOptions)},handleActivePages:function(t){this.$activePagesTableBody.empty(),t.rows&&t.rows.length>0?(this.$activePagesNoData.addClass("hidden"),e.each(t.rows,e.proxy((function(t,i){var s=e("<tr></tr>").appendTo(this.$activePagesTableBody);e('<td class="col-page">'+i[0]+"</td>").appendTo(s),e('<td class="col-users">'+i[1]+"</td>").appendTo(s)}),this)),this.$activePagesTable.removeClass("hidden")):(this.$activePagesTable.addClass("hidden"),this.$activePagesNoData.removeClass("hidden"))},_handleWindowResize:function(){this.chart&&this.chart.draw(this.chartData,this.chartOptions)}},{defaults:{viewId:null,refreshInterval:15}})}(jQuery);
