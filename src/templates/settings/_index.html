{% extends "analytics/_layouts/settings" %}

{% import "_includes/forms" as forms %}

{% set content %}

	<h2 class="first">{{ 'Google Analytics Account'|t('analytics') }}</h2>

	{% if not oauthAccount %}

		{% if errors is defined and errors|length > 0 %}
			<p>{{ 'An error occurred while trying to retrieve account informations:'|t('analytics') }}</p>
			<ul class="error">
				{% for error in errors %}
					<li>{{ error }}</li>
				{% endfor %}
			</ul>
		{% endif %}

		<p>{{ 'Check your {link} before trying to connect.'|t('analytics', { link: '<a href="'~url('analytics/settings/oauth')~'">OAuth settings</a>' })|raw }}</p>

		{% if token %}
			<p><a class="btn small" href="{{ actionUrl('analytics/oauth/disconnect') }}">{{ 'Disconnect'|t('analytics') }}</a></p>
		{% else %}
			<p><a class="btn submit" href="{{ actionUrl('analytics/oauth/connect') }}">{{"Connect"|t('analytics') }}</a></p>
		{% endif %}

	{% else %}

		<p>{{ 'You are authenticated to Google Analytics with the following account'|t('analytics') }} :</p>

		<div class="oauth-account">
			<div class="account-box">
				<div class="image">
					<img src="{{ googleIconUrl }}" height="30" alt="Google OAuth provider">
				</div>
				<div class="details">
					<ul>
						<li><strong>{{ 'Name'|t('analytics') }}: </strong> {{ oauthAccount.name }}</li>

						{% if oauthAccount.uid is defined %}
							<li><strong>{{ 'UID'|t('analytics') }}: </strong> {{ oauthAccount.uid }}</li>
						{% elseif oauthAccount.id is defined %}
							<li><strong>{{ 'UID'|t('analytics') }}: </strong> {{ oauthAccount.id }}</li>
						{% endif %}
					</ul>
				</div>

				<div class="buttons">
					<a class="icon delete" href="{{ actionUrl('analytics/oauth/disconnect') }}"></a>
				</div>
			</div>
		</div>

		{% if settings.forceConnect %}
			<p><a class="btn submit" href="{{ actionUrl('analytics/oauth/connect') }}">{{"Please connect again to Google Analytics"|t('analytics') }}</a></p>
		{% else %}

			<hr />

			<form method="post" accept-charset="UTF-8" data-saveshortcut>

				{{ csrfInput() }}

				<input type="hidden" name="action" value="analytics/settings/save-settings">
				<input type="hidden" name="pluginClass" value="Analytics">
				<input type="hidden" name="redirect" value="{{ 'analytics/settings'|hash }}">

				<div id="account-explorer" class="account-explorer">

					<h2 class="first">{{ "Google Analytics View (Profile)"|t('analytics') }}</h2>

					{{ forms.selectField({
						label: "Account"|t('analytics'),
						name: 'settings[accountId]',
						class: 'account',
						options: accountOptions,
						value: accountId,
					}) }}

					{{ forms.selectField({
						label: "Property"|t('analytics'),
						name: 'settings[webPropertyId]',
						class: 'property',
						options: webPropertyOptions,
						value: webPropertyId,
					}) }}

					{{ forms.selectField({
						label: "View"|t('analytics'),
						name: 'settings[profileId]',
						class: 'view',
						options: viewOptions,
						value: viewId,
					}) }}

					<div class="buttons">
						<div class="btn small refresh-views">Refresh</div> <div class="spinner hidden"></div>
					</div>
				</div>

				{% js %}

					{% if accountExplorerData %}
						var forceRefresh = false;
					{% else %}
						var forceRefresh = true;
					{% endif %}

					var accountExplorer = new Analytics.AccountExplorer('#account-explorer', { forceRefresh: forceRefresh, data: {{ accountExplorerData|json_encode|raw }}  });

				{% endjs %}

				<hr />

				<h2>{{ 'Realtime'|t('analytics') }}</h2>

				{{ forms.checkboxField({
					label: "Enable real-time"|t('analytics'),
					name: 'settings[enableRealtime]',
					checked: (settings.enableRealtime ? settings.enableRealtime : false),
					toggle: 'enableRealtime'
				}) }}

				<div id="enableRealtime"{% if not settings.enableRealtime %} class="hidden"{% endif %}>

					{{ forms.textField({
						label: "Real-Time Refresh Interval"|t('analytics'),
						instructions: "Interval in seconds between requests to real-time API."|t('analytics'),
						name: 'settings[realtimeRefreshInterval]',
						value: (settings.realtimeRefreshInterval ? settings.realtimeRefreshInterval : ''),
						errors: settings.getErrors('realtimeRefreshInterval'),
						size: 4
					}) }}
				</div>

				<div class="buttons">
					<input type="submit" class="btn submit force" value="{{ 'Save'|t('analytics') }}">
				</div>
			</form>

		{% endif %}
	{% endif %}

{% endset %}
