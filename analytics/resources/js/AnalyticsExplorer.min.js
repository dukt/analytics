(function($){var googleVisualisationCalled=!1;AnalyticsExplorer=Garnish.Base.extend({init:function(e,t){this.$element=$("#"+e);this.$error=$(".analytics-error",this.$element);this.$widget=$(".analytics-widget:first",this.$element);if(googleVisualisationCalled==0){typeof AnalyticsChartLanguage=="undefined"&&(AnalyticsChartLanguage="en");console.log("load visualization");google.load("visualization","1",{packages:["corechart","table","geochart"],language:AnalyticsChartLanguage});googleVisualisationCalled=!0}google.setOnLoadCallback($.proxy(function(){if(typeof google.visualization=="undefined"){this.$widget.addClass("hidden");this.$error.html("An unknown error occured");this.$error.removeClass("hidden");return}this.initWidget(e,t)},this))},initWidget:function(e,t){this.timer=!1;this.requestData=!1;this.currentMenu="audienceOverview";this.currentChart="area";this.currentMetric="ga:sessions";this.currentPeriod="month";this.pinned=0;this.chartArea=!1;this.chartGeo=!1;this.chartTable=!1;this.chartPie=!1;this.chartData={table:!1,area:!1};this.$menu=$(".analytics-menu:first select:first",this.$element);this.$browser=$(".analytics-browser:first",this.$element);this.$area=$(".analytics-area",this.$element);this.$geo=$(".analytics-geo",this.$element);this.$pie=$(".analytics-pie",this.$element);this.$table=$(".analytics-table",this.$element);this.$dimensionField=$(".analytics-dimension-field",this.$element);this.$dimension=$(".analytics-dimension select",this.$element);this.$metric=$(".analytics-metric select",this.$element);this.$tableType=$(".analytics-tabletype:first",this.$element);this.$disabledTableType=$(".analytics-disabled-tabletype:first",this.$element);this.$tableTypeBtns=$(".analytics-tabletype .btn",this.$element);this.$period=$(".analytics-period",this.$element);this.$periodSelect=$(".analytics-period select",this.$element);this.$spinner=$(".spinner",this.$element);this.$pin=$(".analytics-pin",this.$element);this.$infosDimension=$(".analytics-infos-dimension",this.$element);this.$infosMetric=$(".analytics-infos-metric",this.$element);this.$infosPeriod=$(".analytics-infos-period",this.$element);this.$infosCount=$(".analytics-infos-count",this.$element);this.$counter=$(".analytics-counter",this.$element);this.$counterValue=$(".analytics-counter-value",this.$element);this.$counterLabel=$(".analytics-counter-label",this.$element);this.$counterPeriod=$(".analytics-counter-period",this.$element);this.$collapsible=$(".analytics-collapsible",this.$element);this.$open=$(".analytics-open",this.$element);this.$realtimeVisitors=$(".analytics-realtime-visitors",this.$element);this.addListener(this.$menu,"change","onMenuChange");this.addListener(this.$tableTypeBtns,"click","onTableTypeChange");this.addListener(this.$open,"click","onOpen");this.addListener(this.$periodSelect,"change","onPeriodChange");this.addListener(this.$pin,"click","onPin");this.addListener(this.$dimension,"change","onChangeDimension");this.addListener(this.$metric,"change","onChangeMetric");this.addListener(Garnish.$win,"resize","resize");this.applySettings(t);this.$spinner.removeClass("body-loading");this.$periodSelect.val(this.currentPeriod);if(this.pinned){this.$pin.addClass("active");this.$collapsible.animate({opacity:0,height:"toggle"},0)}this.$menu.val(this.currentMenu);this.changeMenu(this.currentMenu);this.changeTableType(this.currentChart);this.$dimension.val(this.currentDimension);this.$metric.val(this.currentMetric);this.$period.val(this.currentPeriod);this.browse()},onChangeDimension:function(e){this.currentDimension=$(e.currentTarget).val();this.saveState();this.browse()},onChangeMetric:function(e){this.currentMetric=$(e.currentTarget).val();this.saveState();this.browse()},applySettings:function(settings){typeof settings.menu!="undefined"&&(this.currentMenu=settings.menu);typeof settings.dimension!="undefined"&&(this.currentDimension=settings.dimension);typeof settings.metric!="undefined"&&(this.currentMetric=settings.metric);typeof settings.chart!="undefined"&&(this.currentChart=settings.chart);typeof settings.period!="undefined"&&(this.currentPeriod=settings.period);typeof settings.pinned!="undefined"&&(this.pinned=eval(settings.pinned))},browse:function(){var e={id:this.$widget.data("widget-id"),metric:this.$metric.val(),period:this.$periodSelect.val(),realtime:0};this.$dimensionField.hasClass("hidden")||(e.dimension=this.$dimension.val());this.sectionRealtime&&(e.realtime=1);this.requestData=e;this.request(e)},request:function(e){this.$spinner.removeClass("hidden");$("[data-view]",this.$element).addClass("hidden");$('[data-view="'+this.sectionView+'"]',this.$element).removeClass("hidden");switch(this.sectionView){case"realtimeVisitors":$(".analytics-toolbar").addClass("hidden");this.requestRealtimeVisitors(e);break;case"browser":$(".analytics-toolbar").removeClass("hidden");this.requestBrowser(e)}},requestRealtimeVisitors:function(e){Craft.postActionRequest("analytics/explorer/realtimeVisitors",{},$.proxy(function(e,t){if(t=="success"&&typeof e.error=="undefined"){this.$realtimeVisitors.removeClass("hidden");this.$error.addClass("hidden");this.handleRealtimeVisitorsResponse(e)}else{msg="An unknown error occured.";typeof e!="undefined"&&e&&typeof e.error!="undefined"&&(msg=e.error);this.$realtimeVisitors.addClass("hidden");this.$error.html(msg);this.$error.removeClass("hidden")}this.$spinner.addClass("hidden")},this))},handleRealtimeVisitorsResponse:function(e){var t=e.newVisitor,n=e.returningVisitor,r=n*1+t*1;$(".active-visitors .count",this.$realtimeVisitors).text(r);if(r>0){$(".progress",this.$realtimeVisitors).removeClass("hidden");$(".legend",this.$realtimeVisitors).removeClass("hidden")}else{$(".progress",this.$realtimeVisitors).addClass("hidden");$(".legend",this.$realtimeVisitors).addClass("hidden")}if(r>0)var i=Math.round(100*t/r);else var i=100;var s=100-i;$(".progress-bar.blue",this.$realtimeVisitors).css("width",i+"%");$(".progress-bar.blue span",this.$realtimeVisitors).text(i+"%");i>0?$(".progress-bar.blue",this.$realtimeVisitors).removeClass("hidden"):$(".progress-bar.blue",this.$realtimeVisitors).addClass("hidden");$(".progress-bar.green",this.$realtimeVisitors).css("width",s+"%");$(".progress-bar.green span",this.$realtimeVisitors).text(s+"%");s>0?$(".progress-bar.green",this.$realtimeVisitors).removeClass("hidden"):$(".progress-bar.green",this.$realtimeVisitors).addClass("hidden")},requestBrowser:function(e){var t=$(".btn.active",this.$tableType).data("tabletype");Craft.postActionRequest("analytics/explorer/"+t,e,$.proxy(function(e,n){console.log(e,n);if(n=="success"&&typeof e.error=="undefined"){this.$browser.removeClass("hidden");this.$error.addClass("hidden");this.handleBrowserResponse(e,t)}else{this.$browser.addClass("hidden");this.$error.html(e.error);this.$error.removeClass("hidden")}this.$spinner.addClass("hidden")},this))},handleBrowserResponse:function(e,t){switch(t){case"area":this.handleAreaChartResponse(e);break;case"geo":this.handleGeoChartResponse(e);break;case"pie":this.handlePieChartResponse(e);break;case"table":this.handleTableChartResponse(e);break;case"counter":this.handleCounterResponse(e)}if(typeof e.dimension!="undefined"){this.$infosDimension.removeClass("hidden");this.$infosDimension.html(e.dimension)}else this.$infosDimension.addClass("hidden");this.$infosMetric.html(e.metric);this.$infosPeriod.html(e.period);this.changeTableType(t);var n=!1;this.sectionRealtime&&(typeof e.table!="undefined"&&typeof e.table.rows!="undefined"?e.table.rows.length==0&&(n=!0):n=!0);if(n){this.$infosDimension.addClass("hidden");this.$infosMetric.addClass("hidden");this.$infosPeriod.addClass("hidden");this.$table.addClass("hidden");this.$pie.addClass("hidden");$(".analytics-no-visitors").removeClass("hidden")}else{this.$infosDimension.removeClass("hidden");this.$infosMetric.removeClass("hidden");this.$infosPeriod.removeClass("hidden");$(".analytics-no-visitors").addClass("hidden")}},fillChartData:function(e,t){this.chartData[e]=new google.visualization.DataTable;$.each(t.columns,$.proxy(function(t,n){var r=AnalyticsUtils.parseColumn(n);this.chartData[e].addColumn(r.type,r.label)},this));rows=t.rows;rows=AnalyticsUtils.parseRows(t.columns,t.rows);this.chartData[e].addRows(rows)},handleAreaChartResponse:function(e){this.fillChartData("area",e.area);this.chartArea||(this.chartArea=new google.visualization.AreaChart($(".analytics-chart",this.$area).get(0)));if(this.$periodSelect.val()=="week"){this.areaChartOptions.hAxis.format="E";this.areaChartOptions.hAxis.showTextEvery=1}else if(this.$periodSelect.val()=="month"){this.areaChartOptions.hAxis.format="MMM d";this.areaChartOptions.hAxis.showTextEvery=1}else if(this.$periodSelect.val()=="year"){this.areaChartOptions.hAxis.showTextEvery=1;this.areaChartOptions.hAxis.format="MMM yy";var t=new google.visualization.DateFormat({pattern:"MMMM yyyy"});t.format(this.chartData.area,0)}this.chartArea.draw(this.chartData.area,this.areaChartOptions);this.$infosCount.html(e.total)},handleCounterResponse:function(e){this.$counterValue.html(e.counter.count);this.$counterLabel.html(e.metric);this.$counterPeriod.html(e.period)},handleGeoChartResponse:function(e){this.fillChartData("table",e.table);this.chartGeo||(this.chartGeo=new google.visualization.GeoChart($(".analytics-chart",this.$geo).get(0)));this.chartGeo.draw(this.chartData.table,this.pieChartOptions)},handleTableChartResponse:function(e){this.fillChartData("table",e.table);this.chartTable||(this.chartTable=new google.visualization.Table($(".analytics-chart",this.$table).get(0)));this.chartTable.draw(this.chartData.table,this.tableChartOptions)},handlePieChartResponse:function(e){this.fillChartData("table",e.table);this.chartPie||(this.chartPie=new google.visualization.PieChart($(".analytics-chart",this.$pie).get(0)));this.chartPie.draw(this.chartData.table,this.pieChartOptions)},resize:function(){this.chartArea&&this.chartArea.draw(this.chartData.area,this.areaChartOptions);this.chartTable&&this.chartTable.draw(this.chartData.table,this.tableChartOptions);this.chartPie&&this.chartPie.draw(this.chartData.table,this.pieChartOptions);var e=0;$.each($(".analytics-toolbar select, .analytics-toolbar .btngroup",this.$element),function(){e+=$(this).width()+20});e<this.$widget.width()?this.$widget.removeClass("analytics-small"):this.$widget.addClass("analytics-small")},onPeriodChange:function(e){this.currentPeriod=$(e.currentTarget).val();this.saveState();this.browse()},saveState:function(){var e=$(".btn.active",this.$tableType).data("tabletype"),t={id:this.$widget.data("widget-id"),menu:this.$menu.val(),dimension:this.$dimension.val(),metric:this.$metric.val(),chart:e,period:this.$periodSelect.val(),pinned:this.pinned};Craft.postActionRequest("analytics/explorer/saveWidgetState",t,$.proxy(function(e){},this))},onMenuChange:function(e){$value=$(e.currentTarget).val();this.currentMenu=$value;this.currentNav=$value;this.changeMenu($value);this.browse();this.saveState()},changeMenu:function(e){this.currentNav=e;this.$dimension.html("");this.$metric.html("");this.setSection(e);if(this.sectionDimensions){this.$dimensionField.removeClass("hidden");$.each(this.sectionDimensions,$.proxy(function(e,t){$('<option value="'+t.value+'">'+t.label+"</option>").appendTo(this.$dimension)},this));var t=$("option:first",this.$dimension).attr("value");this.$dimension.val(t)}else this.$dimensionField.addClass("hidden");this.sectionMetrics&&$.each(this.sectionMetrics,$.proxy(function(e,t){$('<option value="'+t.value+'">'+t.label+"</option>").appendTo(this.$metric)},this));if(this.sectionEnabledCharts){this.hideTableTypes();$.each(this.sectionEnabledCharts,$.proxy(function(e,t){this.showTableType(t)},this))}else{this.showTableTypes();this.hideTableType("geo");this.hideTableType("counter");this.hideTableType("area")}if(this.sectionChart){this.$tableTypeBtns.removeClass("active");$('[data-tabletype="'+this.sectionChart+'"]',this.$tableType).addClass("active")}else{this.$tableTypeBtns.removeClass("active");$(".btn:first",this.$tableType).addClass("active")}if(this.sectionRealtime){this.$period.addClass("hidden");this.startRealtime()}else{this.$period.removeClass("hidden");this.stopRealtime()}},setSection:function(e){var t=!1;$.each(AnalyticsBrowserData,$.proxy(function(n,r){n==e&&(t=r)},this));this.sectionUri=!1;this.sectionView=!1;this.sectionDimensions=!1;this.sectionMetrics=!1;this.sectionEnabledCharts=!1;this.sectionRealtime=!1;this.sectionChart=!1;if(t){typeof t.dimensions!="undefined"&&(this.sectionDimensions=t.dimensions);typeof t.metrics!="undefined"&&(this.sectionMetrics=t.metrics);typeof t.enabledCharts!="undefined"&&(this.sectionEnabledCharts=t.enabledCharts);typeof t.realtime!="undefined"&&(this.sectionRealtime=t.realtime);typeof t.chart!="undefined"&&(this.sectionChart=t.chart);typeof t.uri!="undefined"&&(this.sectionUri=t.uri);typeof t.view!="undefined"&&(this.sectionView=t.view)}},startRealtime:function(){this.timer&&this.stopRealtime();this.timer=setInterval($.proxy(function(){var e=this.requestData;e&&this.request(e)},this),AnalyticsRealtimeInterval*1e3)},stopRealtime:function(){clearInterval(this.timer)},showTableTypes:function(){$(".btn",this.$disabledTableType).appendTo(this.$tableType)},hideTableTypes:function(){$(".btn",this.$tableType).appendTo(this.$disabledTableType)},showTableType:function(e){$('[data-tabletype="'+e+'"]',this.$element).appendTo(this.$tableType)},hideTableType:function(e){$('[data-tabletype="'+e+'"]',this.$element).appendTo(this.$disabledTableType)},onOpen:function(e){var t=$(e.currentTarget),n=t.data("account-id"),r=t.data("property-id"),i=t.data("profile-id"),s=this.sectionUri,o="https://www.google.com/analytics/web/?pli=1#"+s+"/a"+n+"w"+r+"p"+i+"/";window.open(o,"_blank")},onTableTypeChange:function(e){var t=$(e.currentTarget).data("tabletype");this.$tableTypeBtns.removeClass("active");$('[data-tabletype="'+t+'"]',this.$tableType).addClass("active");this.saveState();this.browse()},changeTableType:function(e){this.currentChart=e;this.$tableTypeBtns.removeClass("active");$('[data-tabletype="'+e+'"]',this.$tableType).addClass("active");if(e=="table"){this.$table.removeClass("hidden");this.$counter.addClass("hidden");this.$pie.addClass("hidden");this.$area.addClass("hidden");this.$geo.addClass("hidden");if(this.sectionDimensions){this.$dimensionField.removeClass("hidden");this.$infosDimension.removeClass("hidden")}}else if(e=="area"){this.$area.removeClass("hidden");this.$table.addClass("hidden");this.$pie.addClass("hidden");this.$counter.addClass("hidden");this.$dimensionField.addClass("hidden");this.$geo.addClass("hidden")}else if(e=="geo"){this.$pie.addClass("hidden");this.$area.addClass("hidden");this.$table.addClass("hidden");this.$counter.addClass("hidden");this.$geo.removeClass("hidden")}else if(e=="counter"){this.$area.addClass("hidden");this.$table.addClass("hidden");this.$pie.addClass("hidden");this.$counter.removeClass("hidden");this.$dimensionField.addClass("hidden");this.$geo.addClass("hidden")}else{this.$pie.removeClass("hidden");this.$area.addClass("hidden");this.$table.addClass("hidden");this.$counter.addClass("hidden");this.$geo.addClass("hidden");if(this.sectionDimensions){this.$dimensionField.removeClass("hidden");this.$infosDimension.removeClass("hidden")}}this.resize()},onPin:function(){this.$pin.hasClass("active")?this.unpin():this.pin();this.saveState()},pin:function(){this.$pin.addClass("active");this.$collapsible.animate({opacity:0,height:"toggle"},200);this.pinned=1},unpin:function(){this.$pin.removeClass("active");this.$collapsible.animate({opacity:1,height:"toggle"},200);this.pinned=0},areaChartOptions:{theme:"maximized",legend:"none",backgroundColor:"#FFF",colors:["#058DC7"],areaOpacity:.1,pointSize:8,lineWidth:4,chartArea:{},hAxis:{format:"E",textPosition:"in",textStyle:{color:"#058DC7"},showTextEvery:1,baselineColor:"#fff",gridlines:{color:"none"}},vAxis:{textPosition:"in",textStyle:{color:"#058DC7"},baselineColor:"#ccc",gridlines:{color:"#fafafa"},maxValue:0}},pieChartOptions:{theme:"maximized",pieHole:.5,legend:{alignment:"center",position:"top"},chartArea:{top:40,height:"82%"},sliceVisibilityThreshold:1/120},tableChartOptions:{page:"enable"}})})(jQuery);