Analytics.ChartWidget=Garnish.Base.extend({$grid:null,requestData:null,init:function(t,e){this.$element=$("#"+t),this.$title=$(".title",this.$element),this.$body=$(".body",this.$element),this.$date=$(".date",this.$element),this.$spinner=$(".spinner",this.$element),this.$spinner.removeClass("body-loading"),this.$settingsBtn=$(".dk-settings-btn",this.$element),this.$error=$(".error",this.$element),Garnish.$doc.ready($.proxy(function(){this.$grid=$("#main > .grid")},this)),"undefined"!=typeof e.settingsModalTemplate&&(this.settingsModalTemplate=e.settingsModalTemplate),this.addListener(this.$settingsBtn,"click","openSettings"),this.chartRequest=e.request,"undefined"!=typeof this.chartRequest&&(this.requestData=this.chartRequest),this.chartResponse=e.cachedResponse,"undefined"!=typeof this.chartResponse?this.parseResponse(this.chartResponse):this.requestData&&(this.chartResponse=this.sendRequest(this.requestData))},periodChange:function(t){this.requestData&&(this.requestData.period=$(t.currentTarget).val(),this.chartResponse=this.sendRequest(this.requestData))},openSettings:function(t){this.settingsModal?this.settingsModal.show():($form=$('<form class="settingsmodal modal fitted"></form>').appendTo(Garnish.$bod),$body=$('<div class="body"/>').appendTo($form),$container=$(this.settingsModalTemplate).appendTo($body),$footer=$('<div class="footer"/>').appendTo($form),$buttons=$('<div class="buttons right"/>').appendTo($footer),$cancelBtn=$('<div class="btn">'+Craft.t("Cancel")+"</div>").appendTo($buttons),$saveBtn=$('<input type="submit" class="btn submit" value="'+Craft.t("Save")+'" />').appendTo($buttons),new Analytics.ChartWidgetSettings($form,{onSubmit:$.proxy(function(t){t.preventDefault();var e=$("input, textarea, select",$form).filter(":visible");e.push($("select[name=chart]",$form).get(0));var s=e.serializeJSON();this.requestData=s;var i=this.$element.parents(".item"),a=i.index();this.$grid.data("grid").items[a].data("colspan",Number(this.requestData.colspan)),this.$grid.data("grid").refreshCols(!0),this.chartResponse=this.sendRequest(this.requestData),this.settingsModal.hide(),this.saveState()},this)}),this.settingsModal=new Garnish.Modal($form,{visible:!1,resizable:!1}),this.addListener($cancelBtn,"click",function(){this.settingsModal.hide()}),this.$periodSelect=$(".period select",this.settingsModal.$container),this.$chartSelect=$(".chart-select select",this.settingsModal.$container),this.requestData&&(this.$chartSelect.val(this.requestData.chart),this.$chartSelect.trigger("change"),this.$periodSelect.val(this.requestData.period),this.$periodSelect.trigger("change")),Craft.initUiElements($form))},saveState:function(){var t={id:this.$element.data("id"),settings:{colspan:this.requestData.colspan,chart:this.requestData.chart,period:this.requestData.period,options:this.requestData.options}};Craft.queueActionRequest("analytics/saveWidgetState",t,$.proxy(function(t){},this))},sendRequest:function(t){this.$spinner.removeClass("hidden"),$(".chart",this.$body).remove(),this.$error.addClass("hidden"),Craft.postActionRequest("analytics/reports/getChartReport",t,$.proxy(function(t,e){if(this.$spinner.addClass("hidden"),"success"==e&&"undefined"==typeof t.error)this.parseResponse(t);else{var s="An unknown error occured.";"undefined"!=typeof t&&t&&"undefined"!=typeof t.error&&(s=t.error),this.$error.html(s),this.$error.removeClass("hidden")}},this))},parseResponse:function(t){this.$spinner.addClass("hidden"),$chart=$('<div class="chart"></div>'),$chart.appendTo(this.$body),this.$title.html(t.metric),this.$date.html(t.periodLabel),this.chart=new Analytics.Chart($chart,t)}});